<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <title>COMOS WalkinsideJS Example 2 - Coloring</title>
  <style>
    html,
    body {
      height: 100%;
      width: 100%;
      margin: 0px;
      overflow: hidden;
    }

    #wi-viewer-container {
      float: left;
      height: 100%;
      width: 100%;
    }

    .info-panel-item {
      width: 100%;
      border-width: 0px;
      padding: 0px;
      opacity: 0.7;
    }

    #wi-info-panel {
      position: absolute;
      right: 0;
      display: block;
      overflow: auto;
      width: 180px;
    }

    #wi-selected-tags {
      padding-left: 0;
    }

    #wi-selected-tags li * {
      display: inline;
    }

    #wi-selected-tags li input[type='color'] {
      width: 2em;
      margin-right: 0.5em;
    }

  </style>
</head>

<body onload="createView()">
  <div id='wi-viewer-container'></div>
  <div id="wi-info-panel">
    <div id="wi-hint">Click some objects</div>
    <ol id="wi-selected-tags"></ol>
    <input class="info-panel-item" type="button" id="wi-apply-colors" value="Apply colors" />
    <input class="info-panel-item" type="button" id="wi-reset-colors" value="Reset colors" />
  </div>
  <script src="${WALKINSIDE-JS-LOCATION}/walkinside.js"></script>
  <script>
    function createView() {
      console.info('creating view...');
      walkinside.createViewAsync({
        backendAddress: '${WALKINSIDE-JS-LOCATION}',
        targetElementId: 'wi-viewer-container'
      }).then(function (view) {
        console.info('view created.');
        console.info('loading project...');
        return view.loadProjectAsync({
          projectAddress: '${PROJECT-ADDRESS}'
        });
      }).then(function (project) {
        console.info('project loaded:');
        console.info(project);
        var hintElem = document.getElementById('wi-hint');
        var listElem = document.getElementById('wi-selected-tags');
        var tagsAndColors = [];
        var updateList = function () {
          listElem.innerHTML = '';
          for (var i = 0; i < tagsAndColors.length; ++i) {
            var item = tagsAndColors[i];
            var itemElem = document.createElement('li');
            var colorElem = document.createElement('input');
            colorElem.setAttribute('type', 'color');
            colorElem.setAttribute('value', item.color);
            colorElem.setAttribute('data-item-index', i);
            colorElem.addEventListener(
              'change',
              function (e) {
                var colorElem = e.target;
                var itemIndex = colorElem.getAttribute('data-item-index');
                var item = tagsAndColors[itemIndex];
                item.color = colorElem.value;
              });
            var opacityElem = document.createElement('input');
            opacityElem.setAttribute('type', 'checkbox');
            opacityElem.checked = item.opacity === 1
            opacityElem.setAttribute('title', 'Opaque/transparent')
            opacityElem.setAttribute('data-item-index', i);
            opacityElem.addEventListener(
              'change',
              function (e) {
                var opacityElem = e.target;
                var itemIndex = opacityElem.getAttribute('data-item-index');
                var item = tagsAndColors[itemIndex];
                item.opacity = opacityElem.checked ? 1.0 : 0.25;
              });
            var tagElem = document.createElement('div');
            tagElem.innerText = item.tagValue;
            itemElem.appendChild(colorElem);
            itemElem.appendChild(opacityElem);
            itemElem.appendChild(tagElem);
            listElem.appendChild(itemElem);
          }
          hintElem.style.display = tagsAndColors.length > 0 ? 'none' : 'block';
        }
        updateList();
        project.on('change-selection', function (e) {
          if (e.tagValue) {
            tagsAndColors.push({
              color: '#ff0000',
              opacity: 1.0,
              tagValue: e.tagValue,
            });
            updateList();
          }
        });
        var applyElem = document.getElementById('wi-apply-colors');
        applyElem.addEventListener(
          'click',
          function () {
            var colorGroups = [];
            for (var i = 0; i < tagsAndColors.length; ++i) {
              var item = tagsAndColors[i];
              colorGroups.push({
                color: item.color,
                opacity: item.opacity,
                tagValues: [item.tagValue],
              });
            }
            console.info('sending color groups:');
            console.info(colorGroups);
            project.applyColorsAsync({colorGroups: colorGroups})
              .then(function () {
                console.info('colors applied');
              });
          });
        var resetElem = document.getElementById('wi-reset-colors');
        resetElem.addEventListener(
          'click',
          function () {
            project.applyColorsAsync({colorGroups: []})
              .then(function () {
                console.info('colors reset');
              });
            tagsAndColors = [];
            updateList();
          });
      });
    }
  </script>
</body>

</html>
